<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turkey — Visited Places (3D & Animated)</title>

  <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css?v=20251021">

  <!-- Mapbox GL + Turf -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    .hero{position:relative;height:40vh;min-height:320px;margin-top:70px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.72) contrast(1.06)}
    .hero .copy{position:relative;color:#fff;text-align:center;padding:0 1rem}
    .hero h1{font-family:var(--primary-font);font-size:clamp(1.8rem,2.4vw+1rem,3rem);text-shadow:0 2px 8px rgba(0,0,0,.45)}

    .map-wrap{max-width:1100px;margin:0 auto;padding:2rem 1.25rem 0;position:relative}
    .map-title{font-size:.9rem;letter-spacing:.18em;color:#666;margin:0 0 .75rem .2rem}
    #map{width:100%;height:560px;border-radius:12px;border:1px solid var(--border-color);box-shadow:var(--shadow-md);background:#eaeaea}
    .map-ui{position:absolute;top:2.4rem;right:1.6rem;display:flex;gap:.5rem;z-index:3}
    .btn{background:#fff;border:1px solid var(--border-color);border-radius:999px;padding:.4rem .8rem;font-size:.85rem;cursor:pointer}
    .btn.active{background:var(--accent-color);color:#fff;border-color:var(--accent-color)}
    .legend{display:flex;gap:1rem;flex-wrap:wrap;margin:.7rem 0 1.6rem;color:var(--text-light);font-size:var(--text-sm)}
    .chip{display:inline-flex;align-items:center;gap:.4rem}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent-color);border:1px solid rgba(0,0,0,.08)}
    .dash{width:28px;height:0;border-top:2px dashed #555;opacity:.6}

    .container-narrow{max-width:900px;margin:0 auto;padding: 0 1.25rem 3rem}
    .city{display:grid;grid-template-columns:1fr 1.2fr;gap:18px;align-items:start;padding:24px 0;border-bottom:1px solid var(--border-color);scroll-margin-top:90px}
    .city:last-of-type{border-bottom:none}
    .city figure{margin:0;border-radius:12px;overflow:hidden;border:1px solid var(--border-color)}
    .city img{width:100%;height:100%;object-fit:cover;display:block}
    .city h2{margin:.25rem 0 .25rem;font-family:var(--primary-font)}
    .city .lead{color:var(--text-light)}
    .pill{font-size:var(--text-xs);background:var(--hover-color);color:var(--text-color);padding:6px 12px;border-radius:999px;font-weight:600;display:inline-block;margin-bottom:.35rem}

    /* マーカーバッジ */
    .marker-badge{width:26px;height:26px;border-radius:50%;background:var(--accent-color);color:#fff;display:flex;align-items:center;justify-content:center;font:600 12px/1 Inter;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.12);cursor:pointer}
    .marker-badge:hover{transform:scale(1.06)}

    /* Popup微調整 */
    .mapboxgl-popup{max-width:260px;font:12px/1.5 Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif}
    .mapboxgl-popup-content{padding:10px;border-radius:10px}
    .popup-title{font-weight:600;margin-bottom:2px}
    .popup-sub{opacity:.7}
    .popup-link{display:inline-block;margin-top:6px;text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <!-- ナビ -->
  <nav class="main-nav" id="main-nav">
    <div class="nav-container">
      <a href="/" class="nav-logo">Toji Masaya</a>
      <ul class="nav-menu" id="nav-menu">
        <li><a href="/" class="nav-link">Home</a></li>
        <li><a href="/gallery.html" class="nav-link">Gallery</a></li>
        <li><a href="/gear.html" class="nav-link">Gear</a></li>
        <li><a href="/writings.html" class="nav-link">Writings</a></li>
        <li><a href="/trips.html" class="nav-link">Trips</a></li>
      </ul>
      <button class="nav-toggle" id="nav-toggle" aria-label="メニューを開く"><span></span><span></span><span></span></button>
    </div>
  </nav>

  <header class="hero" role="banner">
    <img src="/assets/images/trips/turkey/hero.jpg" alt="Turkey trip">
    <div class="copy">
      <h1>Turkey — Visited Places</h1>
      <p>6都市を3D地形＆測地線アークで“旅の線”に。</p>
    </div>
  </header>

  <section class="map-wrap">
    <div class="map-title">VISITED PLACES MAP</div>
    <div class="map-ui">
      <button class="btn active" id="btn-light">Light</button>
      <button class="btn" id="btn-sat">Satellite</button>
      <button class="btn" id="btn-tour">Play tour</button>
    </div>
    <div id="map" aria-label="Visited places in Turkey"></div>
    <div class="legend">
      <span class="chip"><span class="dot"></span>訪問ポイント（クリックで該当セクションへ）</span>
      <span class="chip"><span class="dash"></span>測地線アーク（移動の雰囲気）</span>
    </div>
  </section>

  <main class="container-narrow">
    <!-- セクション（IDはマーカーと連動） -->
    <section id="safranbolu" class="city">
      <figure><img src="/assets/images/trips/turkey/safranbolu.jpg" alt="Safranbolu"></figure>
      <div>
        <span class="pill">Safranbolu</span>
        <h2>サフランボル — オスマン家屋が並ぶ保存地区</h2>
        <p class="lead">格子窓と白壁、赤茶の屋根。路地の陰影でモノクロが映える。</p>
        <small>座標: 41.2561, 32.6945</small>
      </div>
    </section>

    <section id="cappadocia" class="city">
      <figure><img src="/assets/images/trips/turkey/cappadocia.jpg" alt="Cappadocia"></figure>
      <div>
        <span class="pill">Cappadocia</span>
        <h2>カッパドキア — 風景を埋め尽くす気球の朝</h2>
        <p class="lead">遠近圧縮の効く100mm域が楽しい。岩稜のテクスチャは夕方が本番。</p>
        <small>座標: 38.6431, 34.8419</small>
      </div>
    </section>

    <section id="konya" class="city">
      <figure><img src="/assets/images/trips/turkey/konya.jpg" alt="Konya"></figure>
      <div>
        <span class="pill">Konya</span>
        <h2>コンヤ — セマー儀式の回転と静謐</h2>
        <p class="lead">回転の軌跡は1/10〜1/20秒で。手ブレ補正が効くと楽。</p>
        <small>座標: 37.8667, 32.4846</small>
      </div>
    </section>

    <section id="pamukkale" class="city">
      <figure><img src="/assets/images/trips/turkey/pamukkale.jpg" alt="Pamukkale"></figure>
      <div>
        <span class="pill">Pamukkale</span>
        <h2>パムッカレ — 石灰棚の白と空の青</h2>
        <p class="lead">露出は+1〜+1.7EVで白飛び手前。偏光で反射を制御。</p>
        <small>座標: 37.9200, 29.1208</small>
      </div>
    </section>

    <section id="ephesus" class="city">
      <figure><img src="/assets/images/trips/turkey/ephesus.jpg" alt="Ephesus"></figure>
      <div>
        <span class="pill">Ephesus</span>
        <h2>エフェソス — 古代都市の幾何学</h2>
        <p class="lead">列柱のリズムは望遠で圧縮、装飾はマクロで寄ると楽しい。</p>
        <small>座標: 37.9392, 27.3409</small>
      </div>
    </section>

    <section id="istanbul" class="city">
      <figure><img src="/assets/images/trips/turkey/istanbul.jpg" alt="Istanbul"></figure>
      <div>
        <span class="pill">Istanbul</span>
        <h2>イスタンブール — 海峡の風、夕刻の金色</h2>
        <p class="lead">ガラタ橋のトラムとミナレットのシルエット。スローで都市の呼吸。</p>
        <small>座標: 41.0082, 28.9784</small>
      </div>
    </section>

    <footer class="footer" role="contentinfo" style="margin-top: 32px;">
      <div class="footer-content">
        <p>&copy; 2025 Toji Masaya. All rights reserved.</p>
        <p>Built with care in Japan</p>
      </div>
    </footer>
  </main>

  <script>
    // ナビ
    const navToggle=document.getElementById('nav-toggle');
    const navMenu=document.getElementById('nav-menu');
    navToggle?.addEventListener('click',()=>{navMenu.classList.toggle('active');navToggle.classList.toggle('active');document.body.classList.toggle('nav-open');});
    window.addEventListener('scroll',()=>{const n=document.getElementById('main-nav');window.scrollY>50?n.classList.add('scrolled'):n.classList.remove('scrolled');});

    // ===== Mapbox =====
    window.addEventListener('load', function () {
      mapboxgl.accessToken = 'pk.eyJ1IjoidG9qaW1hc2F5YSIsImEiOiJjbWgwN283dzExeW1pMndzMjZxaWUybzUyIn0.BDVLLueewnDmuhrYtKcUhA';

      let currentStyle = 'light';
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [32.5, 39.0],
        zoom: 4.4,
        pitch: 45,  // 斜め視点で立体感
        bearing: -10
      });
      map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');

      // 地形（DEM）＆空
      map.on('style.load', () => {
        if (!map.getSource('mapbox-dem')) {
          map.addSource('mapbox-dem', {
            type: 'raster-dem',
            url: 'mapbox://mapbox.terrain-rgb',
            tileSize: 512,
            maxzoom: 14
          });
        }
        map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.2 });
        if (!map.getLayer('sky')) {
          map.addLayer({
            id: 'sky',
            type: 'sky',
            paint: {
              'sky-type': 'atmosphere',
              'sky-atmosphere-sun-intensity': 10
            }
          });
        }
        // 3Dビル（ズームイン時）
        if (!map.getLayer('3d-buildings')) {
          map.addLayer({
            id: '3d-buildings',
            source: 'composite',
            'source-layer': 'building',
            filter: ['==', 'extrude', 'true'],
            type: 'fill-extrusion',
            minzoom: 14,
            paint: {
              'fill-extrusion-color': '#d9d9d9',
              'fill-extrusion-height': ['get','height'],
              'fill-extrusion-base': ['get','min_height'],
              'fill-extrusion-opacity': 0.6
            }
          });
        }
      });

      // 訪問地点
      const places = [
        { id:'safranbolu', idx:1, name:'サフランボル (Safranbolu)', coord:[32.6945, 41.2561] },
        { id:'cappadocia', idx:2, name:'カッパドキア (Cappadocia)', coord:[34.8419, 38.6431] },
        { id:'konya',      idx:3, name:'コンヤ (Konya)',           coord:[32.4846, 37.8667] },
        { id:'pamukkale',  idx:4, name:'パムッカレ (Pamukkale)',   coord:[29.1208, 37.9200] },
        { id:'ephesus',    idx:5, name:'エフェソス (Ephesus)',     coord:[27.3409, 37.9392] },
        { id:'istanbul',   idx:6, name:'イスタンブール (Istanbul)',coord:[28.9784, 41.0082] }
      ];

      // 画面フィット
      const bounds = new mapboxgl.LngLatBounds(places[0].coord, places[0].coord);
      for (const p of places) bounds.extend(p.coord);

      map.on('load', () => {
        // アーク（測地線）作成
        const arcs = [];
        for (let i=0;i<places.length-1;i++){
          const gc = turf.greatCircle(
            turf.point(places[i].coord),
            turf.point(places[i+1].coord),
            { npoints: 64 }   // 点数増で滑らかに
          );
          arcs.push(gc);
        }
        const routeFC = turf.featureCollection(arcs);

        map.addSource('arcs', { type:'geojson', data: routeFC });
        map.addLayer({
          id:'arcs-line',
          type:'line',
          source:'arcs',
          paint:{
            'line-color':'#555',
            'line-width': 2.8,
            'line-opacity': 0.65,
            'line-dasharray': [0, 2, 3]   // アニメ前の初期値
          }
        });

        // ダッシュアニメ
        let dash = 0;
        function animateDash(){
          dash = (dash + 0.02) % 3;
          map.setPaintProperty('arcs-line','line-dasharray',[dash,2,3]);
          requestAnimationFrame(animateDash);
        }
        animateDash();

        // マーカー（番号バッジ）＋ポップアップ＋スクロール
        places.forEach(p=>{
          const el = document.createElement('div');
          el.className = 'marker-badge';
          el.textContent = p.idx;
          const popup = new mapboxgl.Popup({ offset: 10 }).setHTML(
            `<div class="popup">
               <div class="popup-title">${p.name}</div>
               <div class="popup-sub">(${p.coord[1].toFixed(4)}, ${p.coord[0].toFixed(4)})</div>
               <a class="popup-link" href="#${p.id}">この場所の記録へ</a>
             </div>`
          );
          new mapboxgl.Marker({ element: el, anchor: 'center' })
            .setLngLat(p.coord)
            .setPopup(popup)
            .addTo(map);

          el.addEventListener('click', () => {
            document.getElementById(p.id)?.scrollIntoView({ behavior:'smooth', block:'start' });
          });
          el.title = p.name;
        });

        map.fitBounds(bounds, { padding: 70, duration: 900, pitch: map.getPitch(), bearing: map.getBearing() });
      });

      // ベースマップ切替
      const btnLight = document.getElementById('btn-light');
      const btnSat = document.getElementById('btn-sat');
      function setStyle(name){
        currentStyle = name;
        btnLight.classList.toggle('active', name==='light');
        btnSat.classList.toggle('active', name==='sat');
        map.setStyle(name==='light' ? 'mapbox://styles/mapbox/light-v11'
                                    : 'mapbox://styles/mapbox/satellite-streets-v12');
      }
      btnLight.addEventListener('click', ()=>setStyle('light'));
      btnSat.addEventListener('click', ()=>setStyle('sat'));

      // ツアーボタン：各地点を順に flyTo
      document.getElementById('btn-tour').addEventListener('click', async ()=>{
        for (const p of places){
          map.flyTo({ center: p.coord, zoom: 7.2, pitch: 55, bearing: -20, speed: 0.6, curve: 1.4, essential: true });
          await new Promise(r=>setTimeout(r, 1400));
        }
        // 〆に全体
        map.fitBounds(new mapboxgl.LngLatBounds(places[0].coord, places[0].coord).extend(places.at(-1).coord), { padding: 70, duration: 900 });
      });

      // ポップアップ内リンクのスムーススクロール（デリゲーション）
      document.addEventListener('click', (e) => {
        const a = e.target.closest('a[href^="#"]');
        if (!a) return;
        const id = a.getAttribute('href').slice(1);
        const target = document.getElementById(id);
        if (target) {
          e.preventDefault();
          target.scrollIntoView({ behavior:'smooth', block:'start' });
        }
      });
    });
  </script>
</body>
</html>
