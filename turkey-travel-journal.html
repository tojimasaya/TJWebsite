<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turkey — Visited Places (3D + Effects, refined markers)</title>

  <!-- 既存フォント & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css?v=20251021">

  <!-- Mapbox GL + Turf -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <meta name="description" content="トルコ周遊の訪問地を3D地形・発光ルート・双方向同期で“読ませる地図”に。マーカー位置を光学的に最適化。">
  <meta name="theme-color" content="#fafafa">
  <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)">

  <style>
    /* ---- ヒーロー ---- */
    .hero{position:relative;height:40vh;min-height:320px;margin-top:70px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.72) contrast(1.06)}
    .hero .copy{position:relative;color:#fff;text-align:center;padding:0 1rem}
    .hero h1{font-family:var(--primary-font);font-size:clamp(1.8rem,2.4vw+1rem,3rem);text-shadow:0 2px 8px rgba(0,0,0,.45)}

    /* ---- Map ---- */
    .map-wrap{max-width:1100px;margin:0 auto;padding:2rem 1.25rem 0;position:relative}
    .map-title{font-size:.9rem;letter-spacing:.18em;color:#666;margin:0 0 .75rem .2rem}
    #map{width:100%;height:560px;border-radius:12px;border:1px solid var(--border-color);box-shadow:var(--shadow-md);background:#eaeaea}
    .map-ui{position:absolute;top:2.4rem;right:1.6rem;display:flex;gap:.5rem;z-index:3}
    .btn{background:#fff;border:1px solid var(--border-color);border-radius:999px;padding:.4rem .8rem;font-size:.85rem;cursor:pointer}
    .btn.active{background:var(--accent-color);color:#fff;border-color:var(--accent-color)}
    .legend{display:flex;gap:1rem;flex-wrap:wrap;margin:.7rem 0 1.6rem;color:var(--text-light);font-size:var(--text-sm)}
    .chip{display:inline-flex;align-items:center;gap:.4rem}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent-color);border:1px solid rgba(0,0,0,.08)}
    .dash{width:28px;height:0;border-top:2px dashed #555;opacity:.6}

    /* ---- 本文 ---- */
    .container-narrow{max-width:900px;margin:0 auto;padding: 0 1.25rem 3rem}
    .city{display:grid;grid-template-columns:1fr 1.2fr;gap:18px;align-items:start;padding:24px 0;border-bottom:1px solid var(--border-color);scroll-margin-top:90px}
    .city:last-of-type{border-bottom:none}
    .city figure{margin:0;border-radius:12px;overflow:hidden;border:1px solid var(--border-color)}
    .city img{width:100%;height:100%;object-fit:cover;display:block}
    .city h2{margin:.25rem 0 .25rem;font-family:var(--primary-font)}
    .city .lead{color:var(--text-light)}
    .pill{font-size:var(--text-xs);background:var(--hover-color);color:var(--text-color);padding:6px 12px;border-radius:999px;font-weight:600;display:inline-block;margin-bottom:.35rem}
    @media (max-width:860px){.city{grid-template-columns:1fr}}

    /* ---- マーカーバッジ + 鼓動（偶数サイズ & 底アンカー前提） ---- */
    .marker-badge{
      position:relative;
      width:28px; height:28px;          /* 偶数で芯が立つ */
      border-radius:50%;
      background:var(--accent-color);
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      font:700 13px/1 Inter, system-ui; /* 視覚中心に来やすい太さ */
      border:2px solid #fff;
      box-shadow:0 0 0 1px rgba(0,0,0,.12);
      cursor:pointer; transition:transform .12s ease;
      -webkit-font-smoothing: antialiased; text-rendering: geometricPrecision;
      transform-origin: bottom center;   /* スケール時のズレを最小化 */
    }
    .marker-badge:hover{transform:scale(1.06)}
    .marker-badge::after{
      content:""; position:absolute; inset:-6px; border-radius:50%;
      border:2px solid rgba(196,154,108,.5);
      transform: scale(0.8); opacity: 0; animation: pulse 2.4s ease-out infinite;
      pointer-events: none;
    }
    @keyframes pulse{
      0%{ transform: scale(0.7); opacity: .6; }
      70%{ transform: scale(1.25); opacity: 0; }
      100%{ transform: scale(1.25); opacity: 0; }
    }

    /* ---- Popup 微調整 ---- */
    .mapboxgl-popup{max-width:260px;font:12px/1.5 Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif}
    .mapboxgl-popup-content{padding:10px;border-radius:10px}
    .popup-title{font-weight:600;margin-bottom:2px}
    .popup-sub{opacity:.7}
    .popup-link{display:inline-block;margin-top:6px;text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <!-- ナビ（既存踏襲） -->
  <nav class="main-nav" id="main-nav">
    <div class="nav-container">
      <a href="/" class="nav-logo">Toji Masaya</a>
      <ul class="nav-menu" id="nav-menu">
        <li><a href="/" class="nav-link">Home</a></li>
        <li><a href="/gallery.html" class="nav-link">Gallery</a></li>
        <li><a href="/gear.html" class="nav-link">Gear</a></li>
        <li><a href="/writings.html" class="nav-link">Writings</a></li>
        <li><a href="/trips.html" class="nav-link">Trips</a></li>
      </ul>
      <button class="nav-toggle" id="nav-toggle" aria-label="メニューを開く"><span></span><span></span><span></span></button>
    </div>
  </nav>

  <header class="hero" role="banner">
    <img src="/assets/images/trips/turkey/hero.jpg" alt="Turkey trip">
    <div class="copy">
      <h1>Turkey — Visited Places</h1>
      <p>3D地形 × 発光ルート × 双方向同期で、“旅の線”を体感。</p>
    </div>
  </header>

  <section class="map-wrap">
    <div class="map-title">VISITED PLACES MAP</div>
    <div class="map-ui">
      <button class="btn active" id="btn-light">Light</button>
      <button class="btn" id="btn-sat">Satellite</button>
      <button class="btn" id="btn-tour">Play tour</button>
      <button class="btn" id="btn-cine">Cinematic</button>
    </div>
    <div id="map" aria-label="Visited places in Turkey"></div>
    <div class="legend">
      <span class="chip"><span class="dot"></span>訪問ポイント（クリックで該当セクションへ）</span>
      <span class="chip"><span class="dash"></span>測地線アーク（発光グラデ + 流れ）</span>
    </div>
  </section>

  <main class="container-narrow">
    <!-- セクション（IDはマーカーと連動） -->
    <section id="safranbolu" class="city">
      <figure><img src="/assets/images/trips/turkey/safranbolu.jpg" alt="Safranbolu"></figure>
      <div>
        <span class="pill">Safranbolu</span>
        <h2>サフランボル — オスマン家屋が並ぶ保存地区</h2>
        <p class="lead">格子窓と白壁、赤茶の屋根。路地の陰影でモノクロが映える。</p>
        <small>座標: 41.2561, 32.6945</small>
      </div>
    </section>

    <section id="cappadocia" class="city">
      <figure><img src="/assets/images/trips/turkey/cappadocia.jpg" alt="Cappadocia"></figure>
      <div>
        <span class="pill">Cappadocia</span>
        <h2>カッパドキア — 風景を埋め尽くす気球の朝</h2>
        <p class="lead">遠近圧縮の効く100mm域が楽しい。岩稜のテクスチャは夕方が本番。</p>
        <small>座標: 38.6431, 34.8419</small>
      </div>
    </section>

    <section id="konya" class="city">
      <figure><img src="/assets/images/trips/turkey/konya.jpg" alt="Konya"></figure>
      <div>
        <span class="pill">Konya</span>
        <h2>コンヤ — セマー儀式の回転と静謐</h2>
        <p class="lead">回転の軌跡は1/10〜1/20秒で。手ブレ補正が効くと楽。</p>
        <small>座標: 37.8667, 32.4846</small>
      </div>
    </section>

    <section id="pamukkale" class="city">
      <figure><img src="/assets/images/trips/turkey/pamukkale.jpg" alt="Pamukkale"></figure>
      <div>
        <span class="pill">Pamukkale</span>
        <h2>パムッカレ — 石灰棚の白と空の青</h2>
        <p class="lead">露出は+1〜+1.7EVで白飛び手前。偏光で反射を制御。</p>
        <small>座標: 37.9200, 29.1208</small>
      </div>
    </section>

    <section id="ephesus" class="city">
      <figure><img src="/assets/images/trips/turkey/ephesus.jpg" alt="Ephesus"></figure>
      <div>
        <span class="pill">Ephesus</span>
        <h2>エフェソス — 古代都市の幾何学</h2>
        <p class="lead">列柱のリズムは望遠で圧縮、装飾はマクロで寄ると楽しい。</p>
        <small>座標: 37.9392, 27.3409</small>
      </div>
    </section>

    <section id="istanbul" class="city">
      <figure><img src="/assets/images/trips/turkey/istanbul.jpg" alt="Istanbul"></figure>
      <div>
        <span class="pill">Istanbul</span>
        <h2>イスタンブール — 海峡の風、夕刻の金色</h2>
        <p class="lead">ガラタ橋のトラムとミナレットのシルエット。スローで都市の呼吸。</p>
        <small>座標: 41.0082, 28.9784</small>
      </div>
    </section>

    <footer class="footer" role="contentinfo" style="margin-top: 32px;">
      <div class="footer-content">
        <p>&copy; 2025 Toji Masaya. All rights reserved.</p>
        <p>Built with care in Japan</p>
      </div>
    </footer>
  </main>

  <script>
    // ナビ（既存踏襲）
    const navToggle=document.getElementById('nav-toggle');
    const navMenu=document.getElementById('nav-menu');
    navToggle?.addEventListener('click',()=>{navMenu.classList.toggle('active');navToggle.classList.toggle('active');document.body.classList.toggle('nav-open');});
    window.addEventListener('scroll',()=>{const n=document.getElementById('main-nav');window.scrollY>50?n.classList.add('scrolled'):n.classList.remove('scrolled');});

    // ===== Mapbox =====
    window.addEventListener('load', function () {
      mapboxgl.accessToken = 'pk.eyJ1IjoidG9qaW1hc2F5YSIsImEiOiJjbWgwN283dzExeW1pMndzMjZxaWUybzUyIn0.BDVLLueewnDmuhrYtKcUhA';

      // 訪問地点（順序に idx 付与）
      const places = [
        { id:'safranbolu', idx:1, name:'サフランボル (Safranbolu)', coord:[32.6945, 41.2561] },
        { id:'cappadocia', idx:2, name:'カッパドキア (Cappadocia)', coord:[34.8419, 38.6431] },
        { id:'konya',      idx:3, name:'コンヤ (Konya)',           coord:[32.4846, 37.8667] },
        { id:'pamukkale',  idx:4, name:'パムッカレ (Pamukkale)',   coord:[29.1208, 37.9200] },
        { id:'ephesus',    idx:5, name:'エフェソス (Ephesus)',     coord:[27.3409, 37.9392] },
        { id:'istanbul',   idx:6, name:'イスタンブール (Istanbul)',coord:[28.9784, 41.0082] }
      ];
      const bounds = new mapboxgl.LngLatBounds(places[0].coord, places[0].coord);
      for (const p of places) bounds.extend(p.coord);

      let currentStyle = 'light';
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: bounds.getCenter(),
        zoom: 4.6,
        pitch: 45,
        bearing: -10
      });
      map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');

      // ルート（測地線アーク集合）を計算
      const arcs = [];
      for (let i=0; i<places.length-1; i++){
        const gc = turf.greatCircle(turf.point(places[i].coord), turf.point(places[i+1].coord), { npoints: 64 });
        arcs.push(gc);
      }
      const routeFC = turf.featureCollection(arcs);

      // カスタムレイヤーを追加（style変更時にも復元）
      function addCustomLayers(){
        // DEM & Terrain
        if (!map.getSource('mapbox-dem')) {
          map.addSource('mapbox-dem', { type: 'raster-dem', url: 'mapbox://mapbox.terrain-rgb', tileSize: 512, maxzoom: 14 });
        }
        map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.2 });

        // Sky
        if (!map.getLayer('sky')) {
          map.addLayer({ id: 'sky', type: 'sky', paint: { 'sky-type': 'atmosphere', 'sky-atmosphere-sun-intensity': 10 } });
        }

        // Hillshade
        if (!map.getLayer('hillshade')) {
          map.addLayer({
            id: 'hillshade',
            type: 'hillshade',
            source: 'mapbox-dem',
            paint: {
              'hillshade-exaggeration': 0.65,
              'hillshade-shadow-color': '#000',
              'hillshade-highlight-color': '#fff'
            }
          }, 'waterway-label');
        }

        // 3D Buildings
        if (!map.getLayer('3d-buildings')) {
          map.addLayer({
            id: '3d-buildings',
            source: 'composite',
            'source-layer': 'building',
            filter: ['==', 'extrude', 'true'],
            type: 'fill-extrusion',
            minzoom: 14,
            paint: {
              'fill-extrusion-color': '#d9d9d9',
              'fill-extrusion-height': ['get','height'],
              'fill-extrusion-base': ['get','min_height'],
              'fill-extrusion-opacity': 0.6
            }
          });
        }

        // アーク：Source + 発光芯 + グロー + 流れるグラデ
        if (!map.getSource('arcs')) {
          map.addSource('arcs', { type:'geojson', data: routeFC, lineMetrics: true });
        }
        if (!map.getLayer('arcs-line')) {
          map.addLayer({
            id:'arcs-line',
            type:'line',
            source:'arcs',
            paint:{
              'line-color':'#c49a6c',
              'line-width': 3.2,
              'line-opacity': 0.9
            }
          });
        }
        if (!map.getLayer('arcs-glow')) {
          map.addLayer({
            id:'arcs-glow',
            type:'line',
            source:'arcs',
            paint:{
              'line-color':'#c49a6c',
              'line-width': 12,
              'line-opacity': 0.22,
              'line-blur': 2.5
            }
          }, 'arcs-line');
        }
        if (!map.getLayer('arcs-gradient')) {
          map.addLayer({
            id:'arcs-gradient',
            type:'line',
            source:'arcs',
            paint:{
              'line-width': 4.2,
              'line-gradient': [
                'interpolate', ['linear'], ['line-progress'],
                0.00, 'rgba(196,154,108,0)',
                0.10, 'rgba(196,154,108,0.2)',
                0.30, 'rgba(196,154,108,0.9)',
                0.60, 'rgba(196,154,108,0.2)',
                0.80, 'rgba(196,154,108,0.0)',
                1.00, 'rgba(196,154,108,0.0)'
              ]
            }
          });
        }
      }

      // 初回ロード
      map.on('load', () => {
        addCustomLayers();

        // マーカー（番号バッジ）＋ポップアップ＋スクロール
        const markerEls = [];
        places.forEach(p=>{
          const el = document.createElement('div');
          el.className = 'marker-badge';
          el.textContent = p.idx;
          el.title = p.name;

          const popup = new mapboxgl.Popup({ offset: [0,10], anchor: 'top' }).setHTML(
            `<div class="popup">
               <div class="popup-title">${p.name}</div>
               <div class="popup-sub">(${p.coord[1].toFixed(4)}, ${p.coord[0].toFixed(4)})</div>
               <a class="popup-link" href="#${p.id}">この場所の記録へ</a>
             </div>`
          );

          new mapboxgl.Marker({ element: el, anchor: 'bottom', offset: [0, -2] }) // 座標=底、微調整-2px
            .setLngLat(p.coord)
            .setPopup(popup)
            .addTo(map);

          el.addEventListener('click', () => {
            document.getElementById(p.id)?.scrollIntoView({ behavior:'smooth', block:'start' });
          });
          markerEls.push(el);
        });

        // 全体フィット
        map.fitBounds(bounds, { padding: 70, duration: 900, pitch: map.getPitch(), bearing: map.getBearing() });

        // 発光グラデの流れアニメ
        (function animateGradient(){
          const layer = map.getLayer('arcs-gradient');
          if (layer) {
            const t = (performance.now() / 3000) % 1; // 3秒周期
            const center = t;
            map.setPaintProperty('arcs-gradient', 'line-gradient', [
              'interpolate', ['linear'], ['+', ['line-progress'], center],
              0.00, 'rgba(196,154,108,0)',
              0.10, 'rgba(196,154,108,0.2)',
              0.30, 'rgba(196,154,108,0.9)',
              0.60, 'rgba(196,154,108,0.2)',
              0.80, 'rgba(196,154,108,0.0)',
              1.00, 'rgba(196,154,108,0.0)'
            ]);
          }
          requestAnimationFrame(animateGradient);
        })();

        // Skyの太陽をゆっくり移動
        (function animateSky(){
          const sky = map.getLayer('sky');
          if (sky) {
            const sun = (performance.now() / 50) % 360; // ゆっくり回転
            map.setPaintProperty('sky', 'sky-atmosphere-sun', [sun, 45]);
          }
          requestAnimationFrame(animateSky);
        })();

        // スクロール → 地図に反映（双方向同期）
        const cities = Array.from(document.querySelectorAll('.city')); // 順序で対応
        const io = new IntersectionObserver((entries)=>{
          entries.forEach(e=>{
            if (e.isIntersecting){
              const idx = cities.indexOf(e.target) + 1; // 1始まり
              const p = places.find(x=>x.idx===idx);
              if (p){
                map.easeTo({ center: p.coord, zoom: 6.6, duration: 800 });
                const el = markerEls[idx-1];
                if (el){
                  el.style.transform = 'scale(1.2)';
                  setTimeout(()=>{ el.style.transform=''; }, 300);
                }
              }
            }
          });
        },{ rootMargin:'-40% 0px -50% 0px', threshold: 0.1 });
        cities.forEach(s=>io.observe(s));

        // ポップアップ内リンクのスムーススクロール（デリゲーション）
        document.addEventListener('click', (e) => {
          const a = e.target.closest('a[href^="#"]');
          if (!a) return;
          const id = a.getAttribute('href').slice(1);
          const target = document.getElementById(id);
          if (target) {
            e.preventDefault();
            target.scrollIntoView({ behavior:'smooth', block:'start' });
          }
        });

        // ツアー（各地点を順に flyTo）
        document.getElementById('btn-tour').addEventListener('click', async ()=>{
          for (const p of places){
            map.flyTo({ center: p.coord, zoom: 7.2, pitch: 55, bearing: -20, speed: 0.6, curve: 1.4, essential: true });
            await new Promise(r=>setTimeout(r, 1400));
          }
          map.fitBounds(bounds, { padding: 70, duration: 900 });
        });

        // Cinematic（俯瞰で回転）
        document.getElementById('btn-cine').addEventListener('click', ()=>{
          const center = bounds.getCenter();
          map.easeTo({ center, zoom: 5.6, pitch: 55, bearing: -20, duration: 1600 });
          let b = -20, t = 0;
          function spin(){
            t += 1; b += 0.15;
            map.setBearing(b);
            if (t < 1200) requestAnimationFrame(spin); // 約20秒
          }
          setTimeout(spin, 1600);
        });
      });

      // スタイル切替（Light / Satellite）— カスタムを復元
      const btnLight = document.getElementById('btn-light');
      const btnSat   = document.getElementById('btn-sat');
      function setStyle(name){
        currentStyle = name;
        btnLight.classList.toggle('active', name==='light');
        btnSat.classList.toggle('active', name==='sat');
        map.setStyle(name==='light' ? 'mapbox://styles/mapbox/light-v11'
                                    : 'mapbox://styles/mapbox/satellite-streets-v12');
      }
      btnLight.addEventListener('click', ()=>setStyle('light'));
      btnSat.addEventListener('click', ()=>setStyle('sat'));

      // 新スタイル読込完了でカスタム復元
      map.on('style.load', addCustomLayers);

      // ズーム時のにじみ抑制（微最適化）
      map.on('zoom', ()=>{
        document.querySelectorAll('.marker-badge').forEach(el=>{
          el.style.willChange = (map.getZoom()%1 !== 0) ? 'transform' : 'auto';
        });
      });
    });
  </script>
</body>
</html>
